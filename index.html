<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
        <meta charset="utf-8"/>
        <title>Forecast</title>
        <link href="style.css" rel="stylesheet" type=" text/css">
    </head>
    <body>
        <div class="background_image"></div>
        <div class="search_city">
            <form id="myForm">
                <div id="input_city11">
                    <input id="submit" type="submit" value="+">
                    <input id="input_city" type="text" placeholder="Search city" name="position" data-positioning="px">
                </div>
                <ul id="hints"></ul>
            </form>
            <input class="button" type="button" value=&#x21e9;>
        </div>
        <div id="mainDiv" class="main_flex">
            <!-- ADD FLEXELEM HERE-->
        </div>
        
        <script type="text/javascript">
            var searchBtn = document.getElementsByClassName("button");
            var searchInput = document.getElementById("input_city");
            var presentTemerature, city;
            var _featuresTab = ["Temp:", , "Pressure:", , "Cloudy:", , "Humidity", ];
            var _hoursTab = [];

            searchBtn[0].addEventListener("click", function(){
                if(searchBtn[0].value === "\u21E9"){
                    var value = 0;
                    searchInputDown(value);
                }
                else{
                    var value = -80;
                    searchInputUp(value);
                    searchInput.value = null;
                    document.getElementById('hints').innerHTML='';
                }
            });

            /*API*/
            //const APP_URL = "api.openweathermap.org/data/2.5 / weather ? q =";
            //const APP_APPID = ",pl&appid=bed4e5796874d1288318fc8b245e8d3e";
            let countryList = [];
            fetch('list.json')
                .then((res) => res.json())
                .then((data) => {
                    data.forEach((city) => {
                        if (city.country == "PL") {
                            countryList.push(city.name);
                        }
                    });
                });

            /*Interactive list of cities*/
            document.getElementById("myForm").addEventListener('keyup', (e) => {
                let list = document.getElementById('hints');
                let text = e.target.value.toLowerCase();
                let items = list.getElementsByTagName('li');
                list.style.position = "absolute";
                list.innerHTML = '';

                if (e.target.value.length > 2) {
                    countryList.forEach((hint) => {
                        let compare = hint;
                        if (compare.toLowerCase().indexOf(text) != -1) {
                            let li = document.createElement('li');
                            li.className = 'list'
                            li.appendChild(document.createTextNode(hint));
                            list.appendChild(li);
                        }
                    });
                }
                
                /* if the city is already on the list */
                Array.from(items).forEach((item) => {
                    var itemName = item.innerText;
                    if (itemName.toLowerCase().indexOf(text) == -1) {
                        item.remove();
                    }
                });
                //let elements = document.querySelectorAll('.list');
                for (var i = 1; i < items.length; i++) { if (items[0].innerText==items[i].innerText) {
                        items[i].remove();
                    } 
                } 
            });

            /* ASSING JSON VALUES TO DOCUMENT.ELEMENT */
            document.getElementById("submit").addEventListener("click", async function (e) {
                e.preventDefault();
                if (searchInput.value != "") {
                    let value = searchInput.value;
                    await fetch(`https://api.openweathermap.org/data/2.5/forecast/hourly?q=${value},pl&units=metric&appid=bed4e5796874d1288318fc8b245e8d3e`)
                        .then((res) => res.json())
                        .then((data) => {
                            city = data.city.name;  //city
                            presentTemerature = data.city.country//present temperature
                            _featuresTab[1] = `${data.city.id}°C`; //sensed temperature
                            _featuresTab[3] = `${data.city.id}hPa`; //pressure
                            _featuresTab[5] = `${data.city.id}%`; //cloudy
                            _featuresTab[7] = `${data.city.id}%`; //humidity
                            _hoursTab[0] = "12:00" //hour1
                            _hoursTab[1] = "42.1°C`" //temp1
                            _hoursTab[2] = "13:00" //hour2
                            _hoursTab[3] = "25.2°C`" //temp2
                            _hoursTab[4] = "14:00" //hour3
                            _hoursTab[5] = "31.1°C`" //temp3
                            _hoursTab[6] = "15:00" //hour4
                            _hoursTab[7] = "16.3°C`" //temp4
                            _hoursTab[8] = "16:00" //hour5
                            _hoursTab[9] = "15.3°C`" //temp5
                            _hoursTab[10] = "17:00" //hour6
                            _hoursTab[11] = "10.4°C`" //temp6
                            createElement();
                        })
                        .catch((err) =>{
                            alert('Nie znaleziono miasta', err);
                        });
                    searchInput.value = null;
                    document.getElementById('hints').innerHTML='';
                }
            });            

            /* FUNCTIONS */
            const searchInputDown = (value) => {
                const suffix = searchInput.dataset.positioning; //px
                document.documentElement.style.setProperty(`--${searchInput.name}`, value + suffix);
                searchBtn[0].value = "\u21E7";
            }
            const searchInputUp = (value) => {
                const suffix = searchInput.dataset.positioning; //px
                document.documentElement.style.setProperty(`--${searchInput.name}`, value + suffix);
                (searchBtn[0].value = "\u21E9");
            }
            const createElement = () => {
                /* id for every new element adding to page */
                var ident = 0;
                if (document.getElementById("flexElem1")) {   //if element already exists
                    element = document.getElementById("flexElem1").id;
                    var ident1 = element.substr(element.length - 1);
                    var classLength = document.getElementsByClassName("Cfeatures");
                    ident = classLength.length + 1;
                }
                else
                    ident = 1;

                /*Array to assing new id to each paragraph requierd it*/
                const _featuresIdTab = [`tempName${ident}`, `tempVal${ident}`, `presName${ident}`,
                    `presVal${ident}`, `cloudName${ident}`, `cloudVal${ident}`, `humName${ident}`, `humVal${ident}`];

                /* CREATE flexElem(new element to add) */
                var newDiv = document.createElement("DIV");
                newDiv.id = `flexElem${ident}`;
                newDiv.className = "CflexElem";
                newDiv.dataset.percent = "%";
                newDiv.name = "topElementPosition";
                newDiv.style.height = "9em";
                newDiv.onclick = function () {
                    var suffix = this.dataset.percent; //%
                    document.documentElement.style.setProperty(`--${newDiv.name}`, 50 + suffix);
                    console.log(this.name);
                };
                /* ADD flexElem TO FLEX BOX(main element) */
                document.getElementById("mainDiv").appendChild(newDiv);

                /* CREATE FEATURES */
                var newFeatures = document.createElement("DIV");
                newFeatures.id = `features${ident}`;
                newFeatures.className = "Cfeatures";
                newFeatures.style.paddingTop = "1.5em";
                /* CREATE present */
                var newPresent = document.createElement("DIV");
                newPresent.id = `present${ident}`;
                newPresent.className = "Cpresent";
                /* CREATE hours */
                var newHours = document.createElement("DIV");
                newHours.id = `hours${ident}`;
                newHours.className = "Chours";
                /* ADD ALL ELEMENTS TO flexElem(new element to add) */
                document.getElementById(`flexElem${ident}`).appendChild(newFeatures);
                document.getElementById(`flexElem${ident}`).appendChild(newPresent);
                document.getElementById(`flexElem${ident}`).appendChild(newHours);

                /* FEATURES */
                for (var i = 0; i < 4; i++) {
                    var div = document.createElement("DIV");
                    div.id = `div${i}${ident}`;
                    document.getElementById(`features${ident}`).appendChild(div);
                    for (var j = 2 * i; j < 2 * (i + 1); j++) {
                        var p = document.createElement("P");
                        p.id = _featuresIdTab[j];
                        p.innerText = _featuresTab[j];
                        p.style.margin = "0px";
                        document.getElementById(`div${i}${ident}`).appendChild(p);
                    }
                }
                /* PRESENT */
                var div = document.createElement("DIV");
                div.id = "image";
                div.className = "present_image"
                document.getElementById(`present${ident}`).appendChild(div);
                var p = document.createElement("P");
                p.innerText = `\n${city}`;
                p.style.marginTop = "0.9em";
                document.getElementById(`present${ident}`).appendChild(p);
                var p = document.createElement("P");
                p.innerText = `Temperature: ${presentTemerature}°C`;
                document.getElementById(`present${ident}`).appendChild(p);
                /* HOURS */
                for (var i = 1; i < 7; i++) {
                    var div = document.createElement("DIV");
                    div.id = `_${i}${ident}`;
                    document.getElementById(`hours${ident}`).appendChild(div);
                    var image = document.createElement("DIV");
                    image.className = `hour_image${i}`;
                    document.getElementById(`_${i}${ident}`).appendChild(image);
                    for (var j = 0; j < 2; j++) {
                        var p = document.createElement("P");
                        p.innerText = _hoursTab[j];
                        document.getElementById(`_${i}${ident}`).appendChild(p);
                    }
                }
            }
        </script>
    </body>
</html>